<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Page Replacement Simulator - OS Platform</title>
  <style>
    :root{
      --bg:#000;--bg-2:#0a0a0a;--panel:#111;--panel-2:#131313;--line:#222;
      --text:#fff;--muted:#b9c2cc;--accent:#00bfff;--btn:#0078ff;--btn-hover:#005ec9;
      --good:#0ecb81;--warn:#ffcc00;--bad:#ff5c5c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* header */
    header{
      position:sticky;top:0;z-index:20;
      display:flex;justify-content:space-between;align-items:center;
      padding:20px 60px;background:var(--bg-2);border-bottom:1px solid var(--line)
    }
    .logo{font-size:1.4em;font-weight:700;color:var(--accent)}
    nav{display:flex;align-items:center;gap:150px}
    .dropdown{position:relative;display:inline-block;padding:6px 0;cursor:pointer}
    .dropdown::after{
      content:" ⌄";display:inline-block;font-size:.8em;color:#ccc;
      transition:transform .25s ease,color .25s ease
    }
    .dropdown:hover::after{transform:rotate(180deg);color:var(--accent)}
    .dropdown-content{
      display:none;position:absolute;background:#111;min-width:180px;
      box-shadow:0 8px 16px rgba(0,0,0,.3);z-index:10
    }
    .dropdown-content a{
      color:#fff;padding:10px 14px;text-decoration:none;display:block
    }
    .dropdown-content a:hover{background:#333}
    .dropdown:hover .dropdown-content{display:block}
    .dropdown > span > a{color:#fff;text-decoration:none}
    .actions{display:flex;align-items:center;gap:20px}
    .login-btn{
      background:var(--btn);color:#fff;border:none;padding:8px 16px;
      border-radius:20px;cursor:pointer;font-weight:700
    }
    .login-btn:hover{background:var(--btn-hover)}
    .profile-btn{background:transparent;border:none;padding:0;cursor:pointer;line-height:0;border-radius:999px;outline:none}
    .profile-btn svg{width:36px;height:36px;background:#fff;border-radius:999px;padding:4px}
    .profile-btn:hover svg{box-shadow:0 0 0 3px rgba(0,191,255,.25)}
    @media (max-width:880px){
      header{padding:16px 20px;flex-wrap:wrap;gap:12px}
      nav{gap:40px}
    }

    .wrap{
      max-width:1150px;
      margin:0 auto;
      padding:40px 24px 120px;
      overflow-x:hidden;
    }
    .eyebrow{
      font-size:.9rem;
      letter-spacing:.12em;
      color:var(--muted);
      text-transform:uppercase
    }
    h1{
      margin:.25rem 0 0;
      font-size:2.1rem;
      line-height:1.2;
    }
    .lead{
      margin-top:12px;
      color:#d7e2ea;
      line-height:1.7;
      font-size:.96rem;
    }

    h2.md{
      font-size:1.4rem;
      margin:30px 0 12px;
    }
    h2.md::before{
      content:"\25C6";
      display:inline-block;
      margin-right:8px;
      color:#34b4ff;
      vertical-align:middle;
    }

    .sim-layout{
      display:grid;
      grid-template-columns:minmax(0,1.35fr) minmax(0,1fr);
      gap:20px;
      margin-top:26px;
      align-items:flex-start;
    }
    @media (max-width:960px){
      .sim-layout{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px 20px 20px;
    }
    .panel-title{
      font-size:1rem;
      font-weight:600;
      margin-bottom:6px;
    }
    .panel-sub{
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:14px;
    }

    .control-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px 16px;
      margin-bottom:12px;
      align-items:flex-end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.85rem;
    }
    .field label{color:#c8d3dc}
    select,input[type="number"],input[type="text"]{
      background:#050506;
      color:var(--text);
      border-radius:10px;
      border:1px solid var(--line);
      padding:6px 8px;
      font-size:.86rem;
      min-width:90px;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
      margin-bottom:4px;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--line);
      padding:7px 14px;
      font-size:.85rem;
      cursor:pointer;
      background:#141820;
      color:#dbe7f5;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary{
      background:var(--btn);
      color:#fff;
      border-color:transparent;
    }
    .btn-primary:hover{background:var(--btn-hover)}
    .btn-danger{
      background:#1b1010;
      color:#ffb3b3;
      border-color:#442020;
    }
    .btn:disabled{
      opacity:0.55;
      cursor:not-allowed;
    }

    .ref-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:.86rem;
    }
    .ref-table th,
    .ref-table td{
      border:1px solid var(--line);
      padding:6px 8px;
      text-align:center;
    }
    .ref-table th{
      background:#111319;
      color:#dbe9f5;
      font-weight:500;
    }
    .idx-cell{
      font-weight:600;
      color:#e6f7ff;
      white-space:nowrap;
    }
    .empty-row{
      font-size:.83rem;
      color:#7d8795;
      text-align:center;
    }

    .howto-list{
      list-style:none;
      padding:0;
      margin:0;
      font-size:.87rem;
      color:#c8d3dc;
    }
    .howto-list li+li{margin-top:6px}
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:.78rem;
      padding:3px 8px;
      line-height:1;
      border-radius:999px;
      border:1px solid var(--line);
      color:#9cc7ff;
      background:#0b1a2a;
      vertical-align:middle;
      margin-right:4px;
    }
    .note-box{
      margin-top:12px;
      padding:10px 12px;
      border-radius:10px;
      border:1px dashed #33495f;
      background:#070a10;
      color:#9bb3c7;
      font-size:.82rem;
    }

    hr.sep{
      border:none;
      border-top:1px solid var(--line);
      margin:30px 0 24px;
      opacity:.6;
    }

    .chart-shell{
      margin-top:4px;
      margin-bottom:14px;
      padding:16px 14px 20px;
      border-radius:14px;
      border:1px dashed var(--line);
      background:#05070c;
    }
    .chart-placeholder{
      height:120px;
      border-radius:10px;
      border:1px solid #1d2633;
      background:radial-gradient(140% 160% at 80% 0%,#102744 0%,#05070c 60%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.85rem;
      color:#93a4ba;
      text-align:center;
      padding:0 12px;
      white-space:pre-line;
    }

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      margin-top:6px;
      margin-bottom:12px;
    }
    @media (max-width:900px){
      .metrics-grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:520px){
      .metrics-grid{grid-template-columns:1fr}
    }
    .metric-card{
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1018;
      padding:8px 10px 9px;
      font-size:.8rem;
    }
    .metric-label{color:#9bb3c7;margin-bottom:3px}
    .metric-value{
      font-size:1rem;
      font-weight:600;
    }
    .metric-unit{font-size:.78rem;color:#7e8a99;margin-left:4px}

    .result-table{
      width:100%;
      border-collapse:collapse;
      font-size:.84rem;
      margin-top:4px;
    }
    .result-table th,
    .result-table td{
      border:1px solid var(--line);
      padding:5px 6px;
      text-align:center;
    }
    .result-table th{
      background:#111319;
      color:#dbe9f5;
    }
    .result-placeholder{
      font-size:.83rem;
      color:#7d8795;
      text-align:center;
    }
    .frames-cell{
      font-family:Menlo,Consolas,monospace;
      font-size:.8rem;
      color:#c8d3dc;
    }

    .run-info{
      margin-top:8px;
      font-size:.82rem;
      color:#9bb3c7;
    }
  </style>
</head>
<body>
<header>
  <a href="/index.html" class="logo">OS Platform</a>

  <nav>
    <!-- Learn -->
    <div class="dropdown">
      <span>Learn</span>
      <div class="dropdown-content">
        <a href="/learn-scheduling.html">CPU Scheduling</a>
        <a href="/learn-paging.html">Page Replacement</a>
        <a href="/learn-deadlock.html">Deadlock</a>
      </div>
    </div>

    <!-- Simulator -->
    <div class="dropdown">
      <span>Simulator</span>
      <div class="dropdown-content">
        <a href="/sim-scheduling.html">CPU Scheduling Simulator</a>
        <a href="/sim-paging.html">Page Replacement Simulator</a>
        <a href="/sim-deadlock.html">Deadlock Simulator</a>
      </div>
    </div>

    <!-- Compare -->
    <div class="dropdown">
      <span>Compare</span>
      <div class="dropdown-content">
        <a href="/compare-scheduling.html">Scheduling Algorithms Compare</a>
        <a href="/compare-paging.html">Paging Algorithms Compare</a>
      </div>
    </div>
  </nav>

  <div class="actions">
    <div id="authArea"></div>
  </div>
</header>

<div class="wrap">
  <div class="eyebrow">SIM / Page Replacement</div>
  <h1>Page Replacement Simulator</h1>
  <p class="lead">
    프레임 수와 참조 문자열을 설정한 뒤, 시뮬레이션을 실행하면<br/>
    <b>총 Page Fault / Fault Rate / Hit 수 / Hit Rate</b>를 한눈에 보고,
    각 접근 단계에서 어떤 페이지가 교체되었는지 확인할 수 있도록 설계된 페이지입니다.
  </p>

  <div class="sim-layout">
    <!-- 설정 -->
    <section class="panel" aria-label="시뮬레이션 설정">
      <div class="panel-title">시뮬레이션 설정</div>
      <div class="panel-sub">
        페이지 교체 알고리즘과 프레임 수를 선택한 뒤, 참조 문자열을 입력하고
        <b>시뮬레이션 실행</b>을 눌러보세요.
      </div>

      <div class="control-row">
        <div class="field">
          <label for="algo-select">알고리즘 선택</label>
          <select id="algo-select">
            <option value="FIFO">FIFO (First In First Out)</option>
            <option value="OPT">OPT (Optimal)</option>
            <option value="LRU">LRU (Least Recently Used)</option>
            <option value="LFU">LFU (Least Frequently Used)</option>
            <option value="NUR">NUR / Clock</option>
          </select>
        </div>

        <div class="field">
          <label for="frame-count">프레임 수 (Frames)</label>
          <input type="number" id="frame-count" min="1" value="3" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn" id="add-ref-btn">+ 참조 추가</button>
        <button type="button" class="btn btn-danger" id="reset-btn">초기화</button>
        <button type="button" class="btn btn-primary" id="run-btn">시뮬레이션 실행</button>
      </div>

      <table class="ref-table" aria-label="참조 문자열">
        <thead>
        <tr>
          <th style="width:70px;">순서</th>
          <th style="width:110px;">페이지 번호</th>
        </tr>
        </thead>
        <tbody id="ref-body">
        <!-- JS에서 #1부터 추가 -->
        </tbody>
      </table>
    </section>

    <!-- 사용법 -->
    <aside class="panel" aria-label="사용 방법">
      <div class="panel-title">사용 방법 &amp; 팁</div>
      <div class="panel-sub">
        입력은 단순하게, 결과는 직관적으로 볼 수 있도록 구성했습니다.
      </div>
      <ul class="howto-list">
        <li>
          <span class="badge">1</span>
          사용할 <b>페이지 교체 알고리즘</b>과 <b>프레임 수</b>를 선택합니다.
        </li>
        <li>
          <span class="badge">2</span>
          <b>참조 추가</b> 버튼을 눌러 #1, #2, #3... 순서대로
          <b>페이지 번호</b>를 입력합니다.
        </li>
        <li>
          <span class="badge">3</span>
          설정을 모두 마쳤다면 <b>시뮬레이션 실행</b>을 눌러
          아래의 <b>Page Fault / Hit 지표</b>와
          <b>접근별 결과 테이블</b>을 확인합니다.
        </li>
        <li>
          <span class="badge">4</span>
          다른 참조열을 보고 싶다면 <b>초기화</b>로 목록을 지우고
          새로운 참조 문자열을 넣어 다시 실행할 수 있습니다.
        </li>
      </ul>

      <div class="note-box">
        현재는 프론트 입력을 받아 <b>백엔드 페이지 교체 API</b>에 요청을 보내
        FIFO / LRU 등의 알고리즘에 대해
        <b>정확한 Page Fault / Hit 지표</b>를 계산하도록 설계할 수 있습니다.
      </div>
    </aside>
  </div>

  <hr class="sep" />

  <!-- 결과 영역 -->
  <section class="panel" aria-label="시뮬레이션 결과">
    <div class="panel-title">시뮬레이션 결과</div>
    <div class="panel-sub">
      위 설정으로 실행한 결과가 이 영역에 표시됩니다.
      접근 순서별 Hit / Fault 여부와 교체된 페이지, 프레임 상태를 한 번에 확인하세요.
    </div>

    <div class="chart-shell">
      <div class="chart-placeholder" id="chart-placeholder">
        아직 시뮬레이션이 실행되지 않았습니다.
        실행 후 이 영역에 타임라인·프레임 상태 등 시각화가 표시됩니다.
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">총 Page Fault 수</div>
        <div><span class="metric-value" id="total-faults">–</span><span class="metric-unit">faults</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Page Fault Rate</div>
        <div><span class="metric-value" id="fault-rate">–</span><span class="metric-unit">%</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">총 Hit 수</div>
        <div><span class="metric-value" id="total-hits">–</span><span class="metric-unit">hits</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Hit Rate</div>
        <div><span class="metric-value" id="hit-rate">–</span><span class="metric-unit">%</span></div>
      </div>
    </div>

    <div class="btn-row" style="margin: 14px 0 4px; gap: 8px;">
      <button type="button" class="btn" id="save-paging-record-btn">
        결과 저장하기
      </button>
    </div>


    <table class="result-table" aria-label="접근별 시뮬레이션 결과">
      <thead>
      <tr>
        <th>순서</th>
        <th>페이지</th>
        <th>결과 (Hit / Fault)</th>
        <th>교체된 페이지</th>
        <th>프레임 상태</th>
      </tr>
      </thead>
      <tbody id="result-body">
      <tr>
        <td colspan="5" class="result-placeholder">
          시뮬레이션을 실행하면 여기에서 각 접근 단계의 결과를 확인할 수 있습니다.
        </td>
      </tr>
      </tbody>
    </table>

    <div class="run-info" id="run-info">
      아직 실행 기록이 없습니다.
    </div>
  </section>
</div>

<script>
  let lastPagingResult = null;
  // --- 로그인 / 프로필 버튼 ---
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('authArea');
    if (container) {
      const user = sessionStorage.getItem('user');
      container.innerHTML = (user && user.trim() !== '')
        ? `
        <button class="profile-btn" aria-label="My Page" title="My Page" onclick="location.href='mypage.html'">
          <svg viewBox="0 0 24 24" fill="black" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="8" r="4"></circle>
            <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
          </svg>
        </button>`
        : `<button class="login-btn" onclick="location.href='login.html'">Login</button>`;
    }
  });

  // --- 참조 추가/초기화 로직 ---
  let refCount = 0;

  function createRefRow(index, pageVal = '') {
    const tbody = document.getElementById('ref-body');

    const placeholder = tbody.querySelector('.empty-row');
    if (placeholder) placeholder.remove();

    const tr = document.createElement('tr');

    const tdIdx = document.createElement('td');
    tdIdx.className = 'idx-cell';
    tdIdx.textContent = '#' + index;

    const tdPage = document.createElement('td');
    const inputPage = document.createElement('input');
    inputPage.type = 'number';
    inputPage.step = '1';
    inputPage.value = pageVal;
    inputPage.setAttribute('aria-label', '#' + index + ' 페이지 번호');
    tdPage.appendChild(inputPage);

    tr.appendChild(tdIdx);
    tr.appendChild(tdPage);
    tbody.appendChild(tr);
  }

  function addReference() {
    refCount += 1;
    createRefRow(refCount);
  }

  function resetSim() {
    const tbody = document.getElementById('ref-body');
    tbody.innerHTML = '';
    refCount = 0;
    addReference(); // 기본 한 줄

    // 지표 리셋
    document.getElementById('total-faults').textContent = '–';
    document.getElementById('fault-rate').textContent = '–';
    document.getElementById('total-hits').textContent = '–';
    document.getElementById('hit-rate').textContent = '–';

    document.getElementById('result-body').innerHTML =
      '<tr><td colspan="5" class="result-placeholder">시뮬레이션을 실행하면 여기에서 각 접근 단계의 결과를 확인할 수 있습니다.</td></tr>';
    document.getElementById('run-info').textContent = '아직 실행 기록이 없습니다.';

    const chartBox = document.getElementById('chart-placeholder');
    chartBox.textContent =
'아직 시뮬레이션이 실행되지 않았습니다.\n실행 후 이 영역에 타임라인·프레임 상태 등 시각화가 표시됩니다.';
  }

  // --- 백엔드 연동 시뮬레이션 실행 ---
  async function runSimulation() {
    const algo = document.getElementById('algo-select').value;   // FIFO / LRU / ...
    const frameCount = parseInt(document.getElementById('frame-count').value, 10);

    if (!frameCount || frameCount <= 0) {
      alert('프레임 수를 1 이상으로 입력해주세요.');
      return;
    }

    // 1) 참조열 입력값 수집
    const tbody = document.getElementById('ref-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const refs = [];

    rows.forEach((row) => {
      const input = row.querySelector('input');
      if (!input) return;
      const val = input.value.trim();
      if (val === '') return;
      const page = parseInt(val, 10);
      if (!Number.isNaN(page)) {
        refs.push(page);
      }
    });

    if (refs.length === 0) {
      alert('페이지 참조열을 한 개 이상 입력해주세요.');
      return;
    }

    try {
      // 2) 백엔드로 요청
      const res = await fetch('/api/sim/paging', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ algo, frames: frameCount, refs })
      });

      if (!res.ok) {
        throw new Error('서버 오류: ' + res.status);
      }

      const data = await res.json();
      const steps = data.steps || [];   // [{ref, frame:[...], fault:true/false}, ...]
      const faults = data.faults ?? 0;

      const total = refs.length;
      const hits = total - faults;
      const faultRate = total > 0 ? ((faults / total) * 100).toFixed(2) : '0.00';
      const hitRate = total > 0 ? ((hits / total) * 100).toFixed(2) : '0.00';

      // 3) 상단 요약 값 채우기
      document.getElementById('total-faults').textContent = faults;
      document.getElementById('fault-rate').textContent = isNaN(faultRate) ? '0.00' : faultRate;
      document.getElementById('total-hits').textContent = hits;
      document.getElementById('hit-rate').textContent = isNaN(hitRate) ? '0.00' : hitRate;

      // 4) 단계별 결과 테이블 채우기
      const resultBody = document.getElementById('result-body');
      resultBody.innerHTML = '';

      steps.forEach((step, idx) => {
        const tr = document.createElement('tr');
        const framesText = '[' + (step.frame || []).join(' ') + ']';
        const victimText = (step.victim === null || step.victim === undefined)
          ? '-'
          : step.victim;

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${step.ref}</td>
          <td style="color:${step.fault ? '#ff5c5c' : '#0ecb81'}">
            ${step.fault ? 'Fault' : 'Hit'}
          </td>
          <td>${victimText}</td>
          <td class="frames-cell">${framesText}</td>
        `;
        resultBody.appendChild(tr);
      });

      // 5) 차트 영역 텍스트
      const chartBox = document.getElementById('chart-placeholder');
      chartBox.textContent =
`[백엔드 결과 기반 타임라인 정보 - ${algo}]
총 접근 수: ${total}
총 Page Fault: ${faults}
총 Hit: ${hits}
Fault Rate: ${isNaN(faultRate) ? '0.00' : faultRate}%
Hit Rate: ${isNaN(hitRate) ? '0.00' : hitRate}%
(추후 이 영역에 프레임 상태 변화를 시각화해서 사용할 수 있습니다.)`;

      // 6) 마지막 실행 정보
      const now = new Date();
      const info = [
        '마지막 실행: ',
        now.toLocaleDateString(), ' ',
        now.toLocaleTimeString(),
        ' | 선택 알고리즘: ', algo,
        ' | 프레임 수: ', frameCount,
        ' | 참조 길이: ', total
      ].join('');
      document.getElementById('run-info').textContent = info;

          // 7) 저장용 결과 구성
    lastPagingResult = {
      type: 'paging',
      title: `Page Replacement (${algo})`,
      algo,
      frameCount,
      refs,          // 사용자가 입력한 참조열 그대로
      faults,
      hits,
      faultRate: Number(faultRate),
      hitRate: Number(hitRate),
      steps          // 각 step의 frame 상태/Hit/Fault 정보
    };


    } catch (err) {
      console.error(err);
      alert('시뮬레이션 중 오류가 발생했습니다.');
    }
  }

  // --- 리액트(3000)에서 8080으로 링크 강제 ---
  (function () {
    if (location.port === '3000') {
      document.querySelectorAll('.dropdown-content a').forEach(a => {
        const href = a.getAttribute('href');
        if (href && href.startsWith('/')) {
          a.addEventListener('click', function (e) {
            e.preventDefault();
            window.location.assign('http://localhost:8080' + href);
          });
        }
      });
    }
  })();

  async function savePagingRecord() {
  if (!lastPagingResult) {
    alert('먼저 시뮬레이션을 실행해주세요.');
    return;
  }

  try {
    const res = await fetch('/api/records', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(lastPagingResult)
    });

    if (!res.ok) {
      throw new Error('status ' + res.status);
    }

    alert('저장하였습니다. 마이페이지에서 확인하세요.');
  } catch (e) {
    console.error(e);
    alert('저장 중 오류가 발생했습니다.');
  }
}


  // 초기 세팅
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('add-ref-btn').addEventListener('click', addReference);
    document.getElementById('reset-btn').addEventListener('click', resetSim);
    document.getElementById('run-btn').addEventListener('click', runSimulation);

    document.getElementById('save-paging-record-btn')
  .addEventListener('click', savePagingRecord);


    resetSim();
  });
</script>
</body>

</html>
