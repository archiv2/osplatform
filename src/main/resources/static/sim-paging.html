<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Page Replacement Simulator - OS Platform</title>
  <style>
    :root{
      --bg:#000;--bg-2:#0a0a0a;--panel:#111;--panel-2:#131313;--line:#222;
      --text:#fff;--muted:#b9c2cc;--accent:#00bfff;--btn:#0078ff;--btn-hover:#005ec9;
      --good:#0ecb81;--warn:#ffcc00;--bad:#ff5c5c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* header */
    header{
      position:sticky;top:0;z-index:20;
      display:flex;justify-content:space-between;align-items:center;
      padding:20px 60px;background:var(--bg-2);border-bottom:1px solid var(--line)
    }
    .logo{font-size:1.4em;font-weight:700;color:var(--accent)}
    nav{display:flex;align-items:center;gap:150px}
    .dropdown{position:relative;display:inline-block;padding:6px 0;cursor:pointer}
    .dropdown::after{
      content:" ⌄";display:inline-block;font-size:.8em;color:#ccc;
      transition:transform .25s ease,color .25s ease
    }
    .dropdown:hover::after{transform:rotate(180deg);color:var(--accent)}
    .dropdown-content{
      display:none;position:absolute;background:#111;min-width:180px;
      box-shadow:0 8px 16px rgba(0,0,0,.3);z-index:10
    }
    .dropdown-content a{
      color:#fff;padding:10px 14px;text-decoration:none;display:block
    }
    .dropdown-content a:hover{background:#333}
    .dropdown:hover .dropdown-content{display:block}
    .actions{display:flex;align-items:center;gap:20px}
    .login-btn{
      background:var(--btn);color:#fff;border:none;padding:8px 16px;
      border-radius:20px;cursor:pointer;font-weight:700
    }
    .login-btn:hover{background:var(--btn-hover)}
    .profile-btn{background:transparent;border:none;padding:0;cursor:pointer;line-height:0;border-radius:999px;outline:none}
    .profile-btn svg{width:36px;height:36px;background:#fff;border-radius:999px;padding:4px}
    .profile-btn:hover svg{box-shadow:0 0 0 3px rgba(0,191,255,.25)}
    @media (max-width:880px){
      header{padding:16px 20px;flex-wrap:wrap;gap:12px}
      nav{gap:40px}
    }

    .wrap{
      max-width:1150px;
      margin:0 auto;
      padding:40px 24px 120px;
      overflow-x:hidden;
    }
    .eyebrow{
      font-size:.9rem;
      letter-spacing:.12em;
      color:var(--muted);
      text-transform:uppercase
    }
    h1{
      margin:.25rem 0 0;
      font-size:2.1rem;
      line-height:1.2;
    }
    .lead{
      margin-top:12px;
      color:#d7e2ea;
      line-height:1.7;
      font-size:.96rem;
    }

    .sim-layout{
      display:grid;
      grid-template-columns:minmax(0,1.35fr) minmax(0,1fr);
      gap:20px;
      margin-top:26px;
      align-items:flex-start;
    }
    @media (max-width:960px){
      .sim-layout{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px 20px 20px;
    }
    .panel-title{
      font-size:1rem;
      font-weight:600;
      margin-bottom:6px;
    }
    .panel-sub{
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:14px;
    }

    .control-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px 16px;
      margin-bottom:12px;
      align-items:flex-end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.85rem;
    }
    .field label{color:#c8d3dc}
    select,input[type="number"]{
      background:#050506;
      color:var(--text);
      border-radius:10px;
      border:1px solid var(--line);
      padding:6px 8px;
      font-size:.86rem;
      min-width:90px;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
      margin-bottom:4px;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--line);
      padding:7px 14px;
      font-size:.85rem;
      cursor:pointer;
      background:#141820;
      color:#dbe7f5;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary{
      background:var(--btn);
      color:#fff;
      border-color:transparent;
    }
    .btn-primary:hover{background:var(--btn-hover)}
    .btn-danger{
      background:#1b1010;
      color:#ffb3b3;
      border-color:#442020;
    }
    .btn:disabled{
      opacity:0.55;
      cursor:not-allowed;
    }

    .ref-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:.86rem;
    }
    .ref-table th,
    .ref-table td{
      border:1px solid var(--line);
      padding:6px 8px;
      text-align:center;
    }
    .ref-table th{
      background:#111319;
      color:#dbe9f5;
      font-weight:500;
    }
    .idx-cell{
      font-weight:600;
      color:#e6f7ff;
      white-space:nowrap;
    }

    .howto-list{
      list-style:none;
      padding:0;
      margin:0;
      font-size:.87rem;
      color:#c8d3dc;
    }
    .howto-list li+li{margin-top:6px}
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:.78rem;
      padding:3px 8px;
      line-height:1;
      border-radius:999px;
      border:1px solid var(--line);
      color:#9cc7ff;
      background:#0b1a2a;
      vertical-align:middle;
      margin-right:4px;
    }
    .note-box{
      margin-top:12px;
      padding:10px 12px;
      border-radius:10px;
      border:1px dashed #33495f;
      background:#070a10;
      color:#9bb3c7;
      font-size:.82rem;
    }

    hr.sep{
      border:none;
      border-top:1px solid var(--line);
      margin:30px 0 24px;
      opacity:.6;
    }

    .frame-caption{
      margin-top:6px;
      font-size:.8rem;
      color:#c0cfdd;
      line-height:1.6;
    }

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      margin-top:6px;
      margin-bottom:12px;
    }
    @media (max-width:900px){
      .metrics-grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:520px){
      .metrics-grid{grid-template-columns:1fr}
    }
    .metric-card{
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1018;
      padding:8px 10px 9px;
      font-size:.8rem;
    }
    .metric-label{color:#9bb3c7;margin-bottom:3px}
    .metric-value{
      font-size:1rem;
      font-weight:600;
    }
    .metric-unit{font-size:.78rem;color:#7e8a99;margin-left:4px}

    .result-table{
      width:100%;
      border-collapse:collapse;
      font-size:.84rem;
      margin-top:4px;
    }
    .result-table th,
    .result-table td{
      border:1px solid var(--line);
      padding:5px 6px;
      text-align:center;
    }
    .result-table th{
      background:#111319;
      color:#dbe9f5;
    }
    .result-placeholder{
      font-size:.83rem;
      color:#7d8795;
      text-align:center;
    }
    .frames-cell{
      font-family:Menlo,Consolas,monospace;
      font-size:.8rem;
      color:#c8d3dc;
    }

    .run-info{
      margin-top:8px;
      font-size:.82rem;
      color:#9bb3c7;
    }

    /* =============================
       Page-flow Visualization 영역
       ============================= */

    .visual-area{
      margin-top:10px;
      padding:10px 14px 16px;
      border:1px dashed var(--line);
      border-radius:14px;
      background:#05070c;
    }

    .visual-layout{
      display:flex;
      gap:18px;
      align-items:flex-start;
    }
    @media (max-width:960px){
      .visual-layout{flex-direction:column}
    }

    .visual-main{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
    }

    .visual-wrapper{
      display:flex;
      align-items:flex-start;
      gap:18px;
      overflow-x:auto;
      padding-bottom:6px;
    }

    .step-column{
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:60px;
    }

    .step-label{
      margin-bottom:8px;
      font-size:.82rem;
      color:#9cb7d1;
    }

    .frame-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
    }

    .old-label,
    .new-label{
      font-size:.75rem;
      color:#7d8795;
      text-align:center;
    }

    .page-box{
      width:38px;
      height:38px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.9rem;
      font-weight:600;
      color:#fff;
      background:#11141d;
      border:1px solid #2c3444;
    }

    .page-empty{
      background:#0a0d13;
      border:1px dashed #333;
    }

    .page-hit{
      border-color:#0ecb81;
      box-shadow:0 0 6px rgba(14,203,129,.5);
    }

    .page-fault-old{
      border-color:#ff5c5c;
      background:#1a0c0c;
    }

    .page-fault-new{
      border-color:#ff5c5c;
      background:#330c0c;
    }

    @keyframes glowPulse{
      0%{ box-shadow:0 0 0px rgba(255,60,60,.3);}
      50%{ box-shadow:0 0 12px rgba(255,60,60,.8);}
      100%{ box-shadow:0 0 0px rgba(255,60,60,.3);}
    }
    .fault-animate{
      animation:glowPulse .8s ease-out;
    }

    @keyframes slideUp{
      0%{opacity:0;transform:translateY(6px);}
      100%{opacity:1;transform:translateY(0);}
    }
    .slide-in{
      animation:slideUp .45s ease-out;
    }

    .status-label{
      font-size:.75rem;
      margin-top:2px;
    }
    .status-fault{color:var(--bad);}
    .status-hit{color:var(--good);}

    /* 범례는 그림 아래 오른쪽 */
    .visual-header{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
    }
    .visual-legend{
      border-radius:10px;
      border:1px dashed #33495f;
      padding:6px 8px;
      font-size:.76rem;
      color:#b9c2cc;
      background:#050811;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-start;
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .legend-box{
      width:18px;
      height:18px;
      border-radius:6px;
      display:inline-block;
    }
    .legend-empty{
      border:1px dashed #444;
      background:#05070c;
    }
    .legend-base{
      border:1px solid #2c3444;
      background:#11141d;
    }
    .legend-hit{
      border:1px solid #0ecb81;
      background:#111f17;
      box-shadow:0 0 4px rgba(14,203,129,.7);
    }
    .legend-fault{
      border:1px solid #ff5c5c;
      background:#2a1010;
      box-shadow:0 0 4px rgba(255,92,92,.7);
    }
  </style>
</head>
<body>
<header>
  <a href="/index.html" class="logo">OS Platform</a>

  <nav>
    <div class="dropdown">
      <span>Learn</span>
      <div class="dropdown-content">
        <a href="/learn-scheduling.html">CPU Scheduling</a>
        <a href="/learn-paging.html">Page Replacement</a>
        <a href="/learn-deadlock.html">Deadlock</a>
      </div>
    </div>

    <div class="dropdown">
      <span>Simulator</span>
      <div class="dropdown-content">
        <a href="/sim-scheduling.html">CPU Scheduling Simulator</a>
        <a href="/sim-paging.html">Page Replacement Simulator</a>
        <a href="/sim-deadlock.html">Deadlock Simulator</a>
      </div>
    </div>

    <div class="dropdown">
      <span>Compare</span>
      <div class="dropdown-content">
        <a href="/compare-scheduling.html">Scheduling Algorithms Compare</a>
        <a href="/compare-paging.html">Paging Algorithms Compare</a>
      </div>
    </div>
  </nav>

  <div class="actions">
    <div id="authArea"></div>
  </div>
</header>

<div class="wrap">
  <div class="eyebrow">SIM / Page Replacement</div>
  <h1>Page Replacement Simulator</h1>
  <p class="lead">
    프레임 수와 참조 문자열을 설정한 뒤, 시뮬레이션을 실행하면<br/>
    <b>총 Page Fault / Fault Rate / Hit 수 / Hit Rate</b>를 한눈에 보고,
    각 접근 단계에서 어떤 페이지가 교체되었는지 확인할 수 있도록 설계된 페이지입니다.
  </p>

  <div class="sim-layout">
    <!-- 설정 -->
    <section class="panel" aria-label="시뮬레이션 설정">
      <div class="panel-title">시뮬레이션 설정</div>
      <div class="panel-sub">
        페이지 교체 알고리즘과 프레임 수를 선택한 뒤, 참조 문자열을 입력하고
        <b>시뮬레이션 실행</b>을 눌러보세요.
      </div>

      <div class="control-row">
        <div class="field">
          <label for="algo-select">알고리즘 선택</label>
          <select id="algo-select">
            <option value="FIFO">FIFO (First In First Out)</option>
            <option value="OPT">OPT (Optimal)</option>
            <option value="LRU">LRU (Least Recently Used)</option>
            <option value="LFU">LFU (Least Frequently Used)</option>
            <option value="NUR">NUR / Clock</option>
          </select>
        </div>

        <div class="field">
          <label for="frame-count">프레임 수 (Frames)</label>
          <input type="number" id="frame-count" min="1" value="3" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn" id="add-ref-btn">+ 참조 추가</button>
        <button type="button" class="btn btn-danger" id="reset-btn">초기화</button>
        <button type="button" class="btn btn-primary" id="run-btn">시뮬레이션 실행</button>
      </div>

      <table class="ref-table" aria-label="참조 문자열">
        <thead>
        <tr>
          <th style="width:70px;">순서</th>
          <th style="width:110px;">페이지 번호</th>
        </tr>
        </thead>
        <tbody id="ref-body">
        </tbody>
      </table>
    </section>

    <!-- 사용법 -->
    <aside class="panel" aria-label="사용 방법">
      <div class="panel-title">사용 방법 &amp; 팁</div>
      <div class="panel-sub">
        입력은 단순하게, 결과는 직관적으로 볼 수 있도록 구성했습니다.
      </div>
      <ul class="howto-list">
        <li>
          <span class="badge">1</span>
          사용할 <b>페이지 교체 알고리즘</b>과 <b>프레임 수</b>를 선택합니다.
        </li>
        <li>
          <span class="badge">2</span>
          <b>참조 추가</b> 버튼을 눌러 #1, #2, #3... 순서대로
          <b>페이지 번호</b>를 입력합니다.
        </li>
        <li>
          <span class="badge">3</span>
          설정을 모두 마쳤다면 <b>시뮬레이션 실행</b>을 눌러
          아래의 <b>Page Fault / Hit 지표</b>와
          <b>접근별 결과 테이블</b>을 확인합니다.
        </li>
        <li>
          <span class="badge">4</span>
          다른 참조열을 보고 싶다면 <b>초기화</b>로 목록을 지우고
          새로운 참조 문자열을 넣어 다시 실행할 수 있습니다.
        </li>
      </ul>

      <div class="note-box">
        현재는 프론트 입력을 받아 <b>백엔드 페이지 교체 API</b>에 요청을 보내
        FIFO / LRU 등의 알고리즘에 대해
        <b>정확한 Page Fault / Hit 지표</b>를 계산하도록 설계할 수 있습니다.
      </div>
    </aside>
  </div>

  <hr class="sep" />

  <!-- 결과 영역 -->
  <section class="panel" aria-label="시뮬레이션 결과">
    <div class="panel-title">시뮬레이션 결과</div>
    <div class="panel-sub">
      위 설정으로 실행한 결과가 이 영역에 표시됩니다.
      접근 순서별 Hit / Fault 여부와 교체된 페이지, 프레임 상태를 한 번에 확인하세요.
    </div>

    <!-- 시각화 영역 -->
    <div class="visual-area">
      <div class="visual-layout">
        <div class="visual-main">
          <div class="visual-wrapper" id="visual-wrapper"></div>

          <div class="visual-header">
            <div class="visual-legend">
              <div class="legend-row">
                <span class="legend-box legend-empty"></span>
                <span> : 비어 있는 프레임</span>
              </div>
              <div class="legend-row">
                <span class="legend-box legend-base"></span>
                <span> : 단순 적재된 페이지</span>
              </div>
              <div class="legend-row">
                <span class="legend-box legend-hit"></span>
                <span> : Hit (재사용)</span>
              </div>
              <div class="legend-row">
                <span class="legend-box legend-fault"></span>
                <span> : Fault로 교체된 페이지</span>
              </div>
            </div>
          </div>

          <div id="visual-caption" class="frame-caption" style="display:none;"></div>
        </div>
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">총 Page Fault 수</div>
        <div><span class="metric-value" id="total-faults">–</span><span class="metric-unit">faults</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Page Fault Rate</div>
        <div><span class="metric-value" id="fault-rate">–</span><span class="metric-unit">%</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">총 Hit 수</div>
        <div><span class="metric-value" id="total-hits">–</span><span class="metric-unit">hits</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Hit Rate</div>
        <div><span class="metric-value" id="hit-rate">–</span><span class="metric-unit">%</span></div>
      </div>
    </div>

    <div class="btn-row" style="margin: 14px 0 4px; gap: 8px;">
      <button type="button" class="btn" id="save-paging-record-btn">
        결과 저장하기
      </button>
    </div>

    <table class="result-table" aria-label="접근별 시뮬레이션 결과">
      <thead>
      <tr>
        <th>순서</th>
        <th>페이지</th>
        <th>결과 (Hit / Fault)</th>
        <th>교체된 페이지</th>
        <th>프레임 상태</th>
      </tr>
      </thead>
      <tbody id="result-body">
      <tr>
        <td colspan="5" class="result-placeholder">
          시뮬레이션을 실행하면 여기에서 각 접근 단계의 결과를 확인할 수 있습니다.
        </td>
      </tr>
      </tbody>
    </table>

    <div class="run-info" id="run-info">
      아직 실행 기록이 없습니다.
    </div>
  </section>
</div>

<script>
  let lastPagingResult = null;


  // 시각화 생성
  function renderVisualSteps(steps, refs){
    const wrap = document.getElementById('visual-wrapper');
    wrap.innerHTML = '';
    if (!steps || steps.length === 0) return;

    const frameLen = (steps[0].frame || []).length;
    let prevFrame = Array(frameLen).fill(null);

    steps.forEach((step) => {
      const col = document.createElement('div');
      col.className = 'step-column';

      const label = document.createElement('div');
      label.className = 'step-label';
      label.textContent = step.ref;
      col.appendChild(label);

      const rowWrapper = document.createElement('div');
      rowWrapper.className = 'frame-row';

      const oldLabel = document.createElement('div');
      oldLabel.className = 'old-label';
      oldLabel.textContent = 'old';
      rowWrapper.appendChild(oldLabel);

      const oldFrame = prevFrame.slice();
      const curFrame = (step.frame || []).slice();

      // old 프레임
      oldFrame.forEach((val)=>{
        const box = document.createElement('div');
        box.className = 'page-box';
        if(val === null || val === undefined){
          box.classList.add('page-empty');
          box.textContent = '';
        } else {
          box.textContent = val;
        }
        if(step.fault && step.victim === val){
          box.classList.add('page-fault-old','fault-animate');
        } else if(!step.fault){
          box.classList.add('page-hit');
        }
        rowWrapper.appendChild(box);
      });

      const newLabel = document.createElement('div');
      newLabel.className = 'new-label';
      newLabel.textContent = 'new';
      rowWrapper.appendChild(newLabel);

      // new 프레임
      curFrame.forEach((val)=>{
        const box = document.createElement('div');
        box.className = 'page-box slide-in';
        if(val === null || val === undefined){
          box.classList.add('page-empty');
          box.textContent = '';
        } else {
          box.textContent = val;
        }
        if(step.fault && val === step.ref){
          box.classList.add('page-fault-new','fault-animate');
        } else if(!step.fault){
          box.classList.add('page-hit');
        }
        rowWrapper.appendChild(box);
      });

      const status = document.createElement('div');
      status.className = 'status-label ' + (step.fault ? 'status-fault' : 'status-hit');
      status.textContent = step.fault ? 'F' : 'H';
      rowWrapper.appendChild(status);

      col.appendChild(rowWrapper);
      wrap.appendChild(col);

      prevFrame = curFrame;
    });
  }

  // 참조 추가/초기화
  let refCount = 0;

  function createRefRow(index, pageVal = '') {
    const tbody = document.getElementById('ref-body');
    const tr = document.createElement('tr');

    const tdIdx = document.createElement('td');
    tdIdx.className = 'idx-cell';
    tdIdx.textContent = '#' + index;

    const tdPage = document.createElement('td');
    const inputPage = document.createElement('input');
    inputPage.type = 'number';
    inputPage.step = '1';
    inputPage.value = pageVal;
    inputPage.setAttribute('aria-label', '#' + index + ' 페이지 번호');
    tdPage.appendChild(inputPage);

    tr.appendChild(tdIdx);
    tr.appendChild(tdPage);
    tbody.appendChild(tr);
  }

  function addReference() {
    refCount += 1;
    createRefRow(refCount);
  }

  function resetSim() {
    const tbody = document.getElementById('ref-body');
    tbody.innerHTML = '';
    refCount = 0;
    addReference();

    document.getElementById('total-faults').textContent = '–';
    document.getElementById('fault-rate').textContent = '–';
    document.getElementById('total-hits').textContent = '–';
    document.getElementById('hit-rate').textContent = '–';

    document.getElementById('result-body').innerHTML =
      '<tr><td colspan="5" class="result-placeholder">시뮬레이션을 실행하면 여기에서 각 접근 단계의 결과를 확인할 수 있습니다.</td></tr>';
    document.getElementById('run-info').textContent = '아직 실행 기록이 없습니다.';

    const wrap = document.getElementById('visual-wrapper');
    if (wrap) wrap.innerHTML = '';

    lastPagingResult = null;
  }

  // 시뮬레이션 실행
  async function runSimulation() {
    const algo = document.getElementById('algo-select').value;
    const frameCount = parseInt(document.getElementById('frame-count').value, 10);

    if (!frameCount || frameCount <= 0) {
      alert('프레임 수를 1 이상으로 입력해주세요.');
      return;
    }

    const tbody = document.getElementById('ref-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const refs = [];

    rows.forEach((row) => {
      const input = row.querySelector('input');
      if (!input) return;
      const val = input.value.trim();
      if (val === '') return;
      const page = parseInt(val, 10);
      if (!Number.isNaN(page)) refs.push(page);
    });

    if (refs.length === 0) {
      alert('페이지 참조열을 한 개 이상 입력해주세요.');
      return;
    }

    try {
      const res = await fetch('/api/sim/paging', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ algo, frames: frameCount, refs })
      });

      if (!res.ok) throw new Error('서버 오류: ' + res.status);

      const data = await res.json();
      const steps = data.steps || [];
      const faults = data.faults ?? 0;

      const total = refs.length;
      const hits = total - faults;
      const faultRate = total > 0 ? ((faults / total) * 100).toFixed(2) : '0.00';
      const hitRate = total > 0 ? ((hits / total) * 100).toFixed(2) : '0.00';

      document.getElementById('total-faults').textContent = faults;
      document.getElementById('fault-rate').textContent = isNaN(faultRate) ? '0.00' : faultRate;
      document.getElementById('total-hits').textContent = hits;
      document.getElementById('hit-rate').textContent = isNaN(hitRate) ? '0.00' : hitRate;

      const resultBody = document.getElementById('result-body');
      resultBody.innerHTML = '';

      steps.forEach((step, idx) => {
        const framesText = '[' + (step.frame || []).join(' ') + ']';
        const victimText = (step.victim === null || step.victim === undefined) ? '-' : step.victim;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${step.ref}</td>
          <td style="color:${step.fault ? '#ff5c5c' : '#0ecb81'}">
            ${step.fault ? 'Fault' : 'Hit'}
          </td>
          <td>${victimText}</td>
          <td class="frames-cell">${framesText}</td>
        `;
        resultBody.appendChild(tr);
      });

      renderVisualSteps(steps, refs);

      const now = new Date();
      const info = [
        '마지막 실행: ',
        now.toLocaleDateString(), ' ',
        now.toLocaleTimeString(),
        ' | 선택 알고리즘: ', algo,
        ' | 프레임 수: ', frameCount,
        ' | 참조 길이: ', total
      ].join('');
      document.getElementById('run-info').textContent = info;

      lastPagingResult = {
        type: 'paging',
        title: `Page Replacement (${algo})`,
        algo,
        frameCount,
        refs,
        faults,
        hits,
        faultRate: Number(faultRate),
        hitRate: Number(hitRate),
        steps
      };

    } catch (err) {
      console.error(err);
      alert('시뮬레이션 중 오류가 발생했습니다.');
    }
  }

  // 3000 포트에서 링크 강제
  (function () {
    if (location.port === '3000') {
      document.querySelectorAll('.dropdown-content a').forEach(a => {
        const href = a.getAttribute('href');
        if (href && href.startsWith('/')) {
          a.addEventListener('click', function (e) {
            e.preventDefault();
            window.location.assign('http://localhost:8080' + href);
          });
        }
      });
    }
  })();

  async function savePagingRecord() {
    if (!lastPagingResult) {
      alert('먼저 시뮬레이션을 실행해주세요.');
      return;
    }

    const user = sessionStorage.getItem('user');
    if (!user || user.trim() === '') {
      alert('로그인이 필요한 서비스입니다.');
      window.location.href = 'login.html';
      return;
    }

    try {
      const res = await fetch('/api/records', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(lastPagingResult)
      });

      if (!res.ok) throw new Error('status ' + res.status);

      alert('저장하였습니다. 마이페이지에서 확인하세요.');
    } catch (e) {
      console.error(e);
      alert('저장 중 오류가 발생했습니다.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {

    const user = sessionStorage.getItem('user');
    if (!user || user.trim() === '') {
      alert('로그인이 필요한 서비스입니다.');
      window.location.href = 'login.html';
      return;
    }

    // 2) 헤더 authArea에 프로필 아이콘 세팅
    const container = document.getElementById('authArea');
    if (container) {
      container.innerHTML = `
        <button class="profile-btn" aria-label="My Page" title="My Page" onclick="location.href='mypage.html'">
          <svg viewBox="0 0 24 24" fill="black" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="8" r="4"></circle>
            <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
          </svg>
        </button>
      `;
    }


    document.getElementById('add-ref-btn').addEventListener('click', addReference);
    document.getElementById('reset-btn').addEventListener('click', resetSim);
    document.getElementById('run-btn').addEventListener('click', runSimulation);
    document.getElementById('save-paging-record-btn').addEventListener('click', savePagingRecord);
    resetSim();
  });
</script>
</body>
</html>
